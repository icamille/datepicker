(function($){var htmlTpl="";htmlTpl='<div class="datepicker" style="display:none;">';htmlTpl+='<div class="controlDiv">';htmlTpl+='    <div class="prevYear">&nbsp;</div>';htmlTpl+='    <div class="prevMonth">&nbsp;</div>';htmlTpl+='    <div class="monthMenu">';htmlTpl+='        <div class="monthTitle"></div>';htmlTpl+='        <div style="display:none;"><input class="monthInput" maxlength="2" value="" /></div>';htmlTpl+='        <div class="monthDiv" style="display:none;"><table class="monthTable" cellpadding="0" cellspacing="0" border="0">';htmlTpl+="        </table></div>";htmlTpl+="    </div>";htmlTpl+='    <div class="yearMenu">';htmlTpl+='        <div class="yearTitle"></div>';htmlTpl+='        <div style="display:none;"><input class="yearInput" maxlength="4" value="" /></div>';htmlTpl+='        <div class="yearDiv" style="display:none;"><table class="yearTable" cellpadding="0" cellspacing="0" border="0">';htmlTpl+='        </table><table class="yearBtnTable" cellpadding="0" cellspacing="0" border="0">';htmlTpl+='            <tr><td class="prevTenYears">←</td><td class="closeYear">×</td><td class="nextTenYears">→</td></tr>';htmlTpl+="        </table></div>";htmlTpl+="    </div>";htmlTpl+='    <div class="nextMonth">&nbsp;</div>';htmlTpl+='    <div class="nextYear">&nbsp;</div>';htmlTpl+="</div>";htmlTpl+='<div class="dateDiv">';htmlTpl+='    <table width="100%" cellpadding="0" cellspacing="0" border="0">';htmlTpl+="    </table>";htmlTpl+="</div>";htmlTpl+="</div>";$.Datepicker=function(elm,options){this.$elm=$(elm);this.opts=$.extend({},$.fn.datepicker.defaults,options);this.opts.firstDay=this.opts.firstDay%7;this.$picker=$(htmlTpl).appendTo(document.body);this.init();};$.Datepicker.initialized=false;$.Datepicker.curInst=null;$.Datepicker.initGlobalEvent=function(){$(document).mousedown(function(e){var $target=$(e.target),that=$.Datepicker.curInst,$picker;if(that){$picker=that.$picker;if($target.get(0).outerHTML!==that.$elm.get(0).outerHTML&&!$target.is(".datepicker")&&$target.parents(".datepicker").length<1){return that.processError();}if($picker.find(".monthDiv").is(":visible")&&(!$target.is(".monthDiv")&&$target.parents(".monthDiv").length<1&&!$target.is(".monthInput"))){that.hideMonthTable();}if($picker.find(".yearDiv").is(":visible")&&(!$target.is(".yearDiv")&&$target.parents(".yearDiv").length<1&&!$target.is(".yearInput"))){that.hideYearTable();}}});};$.Datepicker.prototype={dateFormatReg:/^\d{4}-(?:0[1-9]|1[0-2])-(?:0[1-9]|[12][0-9]|3[01])$/i,init:function(){if(!$.Datepicker.initialized){$.Datepicker.initGlobalEvent();$.Datepicker.initialized=true;}this.initInputEvent();this.initPickerEvent();},initInputEvent:function(){var that=this,$picker=this.$picker;this.$elm.on(this.opts.showOn,function(e){$.Datepicker.curInst=that;that.show();}).on("keyup",function(e){var keyCode=e.which,curVal=$(this).val(),curValLen=curVal.length,posObj=$(this).textposition();if((keyCode>95&&keyCode<106)||(keyCode>47&&keyCode<58)){if((posObj.start===4||posObj.start===7)){if(curVal.charAt(posObj.start)!=="-"){$(this).textposition("-");$(this).moveposition(posObj.start,1);}}posObj=$(this).textposition();curVal=$(this).val();curValLen=curVal.length;if(posObj.start===6){if(parseInt(curVal.charAt(5),10)>1&&!/^\d$/i.test(curVal.charAt(6))){$(this).moveposition(posObj.start,-1);$(this).textposition("0");$(this).moveposition(1-posObj.start,1);if(!$.support.leadingWhitespace){$(this).moveposition(posObj.start,0);}else{$(this).moveposition(posObj.start,1);}if($(this).val().charAt(posObj.start+1)!=="-"){$(this).textposition("-");$(this).moveposition(posObj.start+1,1);}}}if(posObj.start===9){if(parseInt(curVal.charAt(8),10)>3&&!/^\d$/i.test(curVal.charAt(9))){$(this).moveposition(posObj.start,-1);$(this).textposition("0");$(this).moveposition(posObj.start,1);}}}}).on("keydown",function(e){var keyCode=e.which,curVal=$(this).val(),curValLen=curVal.length,posObj=$(this).textposition();if(keyCode===8||keyCode===46){return true;}if(keyCode===37||keyCode===39){return true;}if(keyCode===36||keyCode===35){return true;}if(keyCode===9){$picker.find(".monthTitle").hide().siblings().show();$picker.find(".monthInput").focus().moveposition(0,2,true);return false;}if((keyCode>95&&keyCode<106)||(keyCode>47&&keyCode<58)){return true;}if(keyCode===109||keyCode===173){if(posObj.start!==4&&posObj.start!==7){return false;}return true;}return false;});},initPickerEvent:function(){var that=this,$picker=this.$picker;$picker.on("mouseover mouseout",".dateDiv td.pickDay",function(e){$(this).toggleClass("hover");}).on("mouseover mouseout",".monthDiv td.pickMonth,.yearDiv td.pickYear",function(e){$(this).toggleClass("menuHover");}).on("keydown",".monthInput,.yearInput",function(e){if(e.which===9){that.$elm.focus();that.hideMonthTable();that.hideYearTable();return false;}}).on("click",".dateDiv td.pickDay",function(e){var actDay=parseInt($(this).html(),10);if(isNaN(actDay)||actDay<1){return false;}that.setDateValue(parseInt($picker.find(".yearInput").val(),10),parseInt($picker.find(".monthInput").val(),10),actDay);$(this).addClass("active").siblings().removeClass("active").end().parent().siblings().find("td").removeClass("active");that.hide();if(typeof that.opts.onSelect==="function"){that.opts.onSelect.call(that);}}).on("click",".monthTitle",function(e){$(this).hide().siblings().show();$picker.find(".monthInput").focus().moveposition(0,2,true);}).on("click",".yearTitle",function(e){$(this).hide().siblings().show();$picker.find(".yearInput").focus().moveposition(0,4,true);}).on("click",".monthTable td.pickMonth",function(e){var actYear=parseInt($picker.find(".yearInput").val(),10),actMonth=parseInt($(this).attr("monthData"),10),actDay=parseInt($picker.find(".active").html(),10),monthDays;monthDays=that.getMonthDays(actYear,actMonth);actDay=actDay>monthDays?monthDays:actDay;$picker.find(".monthInput").val(actMonth);$picker.find(".monthTitle").html($(this).html());that.hideMonthTable();that.refresh(actYear,actMonth,actDay);}).on("click",".yearTable td.pickYear",function(e){var actYear=parseInt($(this).html(),10),actMonth=parseInt($picker.find(".monthInput").val(),10),actDay=parseInt($picker.find(".active").html(),10),monthDays,minDate=that.getDateObj(that.opts.minDate),maxDate=that.getDateObj(that.opts.maxDate);monthDays=that.getMonthDays(actYear,actMonth);actDay=actDay>monthDays?monthDays:actDay;$picker.find(".yearInput").val(actYear);$picker.find(".yearTitle").html(actYear);that.hideYearTable();if(actYear===minDate.year){if(actMonth<minDate.month){actMonth=minDate.month;}if(actMonth===minDate.month&&actDay<minDate.day){actDay=minDate.day;}}if(actYear===maxDate.year){if(actMonth>maxDate.month){actMonth=maxDate.month;}if(actMonth===maxDate.month&&actDay>maxDate.day){actDay=maxDate.day;}}that.refresh(actYear,actMonth,actDay);}).on("click",".closeYear",function(e){that.hideYearTable();}).on("click",".prevTenYears.ctrlYear",function(e){$picker.find(".yearTable").html(that.getYearTable(parseInt($(this).parents(".yearDiv").find("td:first").html(),10)-5));}).on("click",".nextTenYears.ctrlYear",function(e){$picker.find(".yearTable").html(that.getYearTable(parseInt($(this).parents(".yearDiv").find("td:first").html(),10)+15));}).on("click",".prevYear",function(e){var actYear=parseInt($picker.find(".yearInput").val(),10)-1,actMonth=parseInt($picker.find(".monthInput").val(),10),actDay=parseInt($picker.find(".active").html(),10),monthDays,minDate=that.getDateObj(that.opts.minDate);if(actYear<minDate.year||(actYear===minDate.year&&actMonth<minDate.month)){that.refresh(minDate.year,minDate.month,actDay>minDate.day?actDay:minDate.day);return false;}monthDays=that.getMonthDays(actYear,actMonth);that.refresh(actYear,actMonth,actDay>monthDays?monthDays:actDay);}).on("click",".prevMonth",function(e){var actYear=parseInt($picker.find(".yearInput").val(),10),actMonth=parseInt($picker.find(".monthInput").val(),10),actDay=parseInt($picker.find(".active").html(),10),monthDays,minDate=that.getDateObj(that.opts.minDate);if(actMonth===1){actMonth=12;actYear-=1;}else{actMonth-=1;}if(actYear<minDate.year||(actYear===minDate.year&&actMonth<=minDate.month)){that.refresh(minDate.year,minDate.month,actDay>minDate.day?actDay:minDate.day);return false;}monthDays=that.getMonthDays(actYear,actMonth);that.refresh(actYear,actMonth,actDay>monthDays?monthDays:actDay);}).on("click",".nextMonth",function(e){var actYear=parseInt($picker.find(".yearInput").val(),10),actMonth=parseInt($picker.find(".monthInput").val(),10),actDay=parseInt($picker.find(".active").html(),10),monthDays,maxDate=that.getDateObj(that.opts.maxDate);if(actMonth===12){actMonth=1;actYear+=1;}else{actMonth+=1;}if(actYear>maxDate.year||(actYear===maxDate.year&&actMonth>=maxDate.month)){that.refresh(maxDate.year,maxDate.month,actDay<maxDate.day?actDay:maxDate.day);return false;}monthDays=that.getMonthDays(actYear,actMonth);that.refresh(actYear,actMonth,actDay=actDay>monthDays?monthDays:actDay);}).on("click",".nextYear",function(e){var actYear=parseInt($picker.find(".yearInput").val(),10)+1,actMonth=parseInt($picker.find(".monthInput").val(),10),actDay=parseInt($picker.find(".active").html(),10),monthDays,maxDate=that.getDateObj(that.opts.maxDate);if(actYear>maxDate.year||(actYear===maxDate.year&&actMonth>maxDate.month)){that.refresh(maxDate.year,maxDate.month,actDay<maxDate.day?actDay:maxDate.day);return false;}monthDays=that.getMonthDays(actYear,actMonth);that.refresh(actYear,actMonth,actDay>monthDays?monthDays:actDay);});},refresh:function(year,month,day){var $picker=this.$picker;$picker.find(".yearInput").val(year);$picker.find(".monthInput").val(month);this.setDateValue(year,month,day);this.showByDate(this.getActiveDate());},setDateValue:function(year,month,day){this.$elm.val(year+"-"+(month<10?"0"+month:month)+"-"+(day<10?"0"+day:day));},show:function(){if(this.$picker.is(":hidden")){this.showByDate(this.getActiveDate());this.setPos();}},hide:function(){this.$picker.hide();},calcPos:function(){var $elm=this.$elm,elmOffset=$elm.offset(),posObj={l:elmOffset.left,t:elmOffset.top,w:$elm.outerWidth(),h:$elm.outerHeight(),sl:$elm.scrollLeft(),st:$elm.scrollTop(),ol:$elm.get(0).offsetLeft,ot:$elm.get(0).offsetTop};return posObj;},setPos:function(){var $elm=this.$elm,elmOffset=$elm.offset(),posObj={l:elmOffset.left,t:elmOffset.top,w:$elm.outerWidth(),h:$elm.outerHeight()};this.$picker.css({left:posObj.l,top:posObj.t+posObj.h,position:"absolute"});},showByDate:function(dateObj){var $picker=this.$picker,curDateObj=this.getCurDate();$picker.find(".monthTitle").html(dateObj.curMonthName);$picker.find(".monthInput").val(dateObj.curMonth);$picker.find(".yearTitle").html(dateObj.curYear);$picker.find(".yearInput").val(dateObj.curYear);$picker.find(".monthTable").html(this.getMonthTable(dateObj.curYear));$picker.find(".yearTable").html(this.getYearTable(dateObj.curYear));$picker.find(".dateDiv table").html(this.getDateTable(curDateObj,dateObj,this.getWeekByDate(dateObj.curYear,dateObj.curMonth,1)));this.hideMonthTable();this.hideYearTable();$picker.show();},hideMonthTable:function(){this.$picker.find(".monthTitle").show().siblings().hide();},hideYearTable:function(){this.$picker.find(".yearTitle").show().siblings().hide();},refreshYearCtrl:function(actYear){var $picker=this.$picker,minDate=this.getDateObj(this.opts.minDate),maxDate=this.getDateObj(this.opts.maxDate);$picker.find(".prevTenYears,.nextTenYears").removeClass("ctrlYear invalid");if(actYear-6>=minDate.year){$picker.find(".prevTenYears").addClass("ctrlYear");}else{$picker.find(".prevTenYears").addClass("invalid");}if(actYear+5<=maxDate.year){$picker.find(".nextTenYears").addClass("ctrlYear");}else{$picker.find(".nextTenYears").addClass("invalid");}},getMonthTable:function(actYear){var i=0,tblHtml="",monthClass,minDate=this.getDateObj(this.opts.minDate),maxDate=this.getDateObj(this.opts.maxDate);for(i=0;i<6;i+=1){monthClass=[];if((actYear===minDate.year&&(i+1)<minDate.month)||(actYear===maxDate.year&&(i+1)>maxDate.month)){monthClass.push("invalid");}else{monthClass.push("pickMonth");}tblHtml+='<tr><td class="'+monthClass.join(" ")+'" monthData="'+(i+1)+'">'+this.opts.months[i]+"</td>";monthClass=[];if((actYear===minDate.year&&(i+7)<minDate.month)||(actYear===maxDate.year&&(i+7)>maxDate.month)){monthClass.push("invalid");}else{monthClass.push("pickMonth");}tblHtml+='<td class="'+monthClass.join(" ")+'" monthData="'+(i+7)+'">'+this.opts.months[i+6]+"</td></tr>";}return tblHtml;},getYearTable:function(actYear){var i=0,tblHtml="",yearClass,minDate=this.getDateObj(this.opts.minDate),maxDate=this.getDateObj(this.opts.maxDate);for(i=0;i<5;i+=1){yearClass=[];if((actYear+i-5)<minDate.year||(actYear+i-5)>maxDate.year){yearClass.push("invalid");}else{yearClass.push("pickYear");}tblHtml+='<tr><td class="'+yearClass.join(" ")+'">'+(actYear+i-5)+"</td>";yearClass=[];if((actYear+i)<minDate.year||(actYear+i)>maxDate.year){yearClass.push("invalid");}else{yearClass.push("pickYear");}tblHtml+='<td class="'+yearClass.join(" ")+'">'+(actYear+i)+"</td></tr>";}this.refreshYearCtrl(actYear);return tblHtml;},getDateTable:function(curDateObj,actDateObj,firstWeek){var weekNames=this.opts.weekNames,$picker=this.$picker,i=0,tblHtml="",year=actDateObj.curYear,month=actDateObj.curMonth,day=actDateObj.curDay,week=actDateObj.curWeek,monthDays=this.getMonthDays(year,month),weeks=Math.ceil(monthDays/7),isCurYearMonth=false,isActYearMonth=false,dayClass=[],minDate=this.getDateObj(this.opts.minDate),maxDate=this.getDateObj(this.opts.maxDate);tblHtml+='<tr class="weekTitle">';for(i=this.opts.firstDay;i<weekNames.length;i+=1){tblHtml+="<th>"+weekNames[i]+"</th>";}for(i=0;i<this.opts.firstDay;i+=1){tblHtml+="<th>"+weekNames[i]+"</th>";}tblHtml+="</tr>";firstWeek=firstWeek>=this.opts.firstDay?firstWeek:firstWeek+7;isCurYearMonth=$picker.find(".yearInput").val()===curDateObj.curYear.toString()&&$picker.find(".monthInput").val()===curDateObj.curMonth.toString();isActYearMonth=$picker.find(".yearInput").val()===year.toString()&&$picker.find(".monthInput").val()===month.toString();tblHtml+="<tr>";for(i=this.opts.firstDay;i<firstWeek;i+=1){tblHtml+="<td>&nbsp;</td>";}for(i=1;i<=monthDays;i+=1){dayClass=[];if((minDate&&(minDate.year>year||(minDate.year===year&&minDate.month>month)||(minDate.year===year&&minDate.month===month&&minDate.day>i)))||(maxDate&&(maxDate.year<year||(maxDate.year===year&&maxDate.month<month)||(maxDate.year===year&&maxDate.month===month&&maxDate.day<i)))){dayClass.push("invalid");}else{dayClass.push("pickDay");}if(i===day&&isActYearMonth){dayClass.push("active");}if(i===curDateObj.curDay&&isCurYearMonth){dayClass.push("today");}tblHtml+='<td class="'+dayClass.join(" ")+'">'+i+"</td>";if((i+firstWeek-this.opts.firstDay)%7===0){tblHtml+="</tr>";tblHtml+="<tr>";}}for(i=0;i<(7-(monthDays+firstWeek-this.opts.firstDay)%7)%7;i+=1){tblHtml+="<td>&nbsp;</td>";}tblHtml+="</tr>";return tblHtml;},getCurDate:function(){var curDate=new Date();return{curYear:curDate.getFullYear(),curMonth:curDate.getMonth()+1,curMonthName:this.opts.months[curDate.getMonth()],curDay:curDate.getDate(),curWeek:curDate.getDay()};},getActiveDate:function(){var dateStr=this.$elm.val(),dateArr=[];if(this.dateFormatReg.test(dateStr)){dateArr=dateStr.split("-");dateArr[0]=parseInt(dateArr[0],10);dateArr[1]=parseInt(dateArr[1],10);dateArr[2]=parseInt(dateArr[2],10);return{curYear:dateArr[0],curMonth:dateArr[1],curMonthName:this.opts.months[dateArr[1]-1],curDay:dateArr[2],curWeek:this.getWeekByDate(dateArr[0],dateArr[1]-1,dateArr[2])};}return this.getCurDate();},getWeekByDate:function(year,month,day){return new Date(year,month-1,day).getDay();},isLeapYear:function(year){return(year%4===0&&year%100!==0)||year%400===0;},getMonthDays:function(year,month){switch(month){case 1:case 3:case 5:case 7:case 8:case 10:case 12:return 31;case 4:case 6:case 9:case 11:return 30;case 2:return this.isLeapYear(year)?29:28;}},getDateObj:function(mixDate){var dateType=typeof mixDate,rawDateType=Object.prototype.toString.call(mixDate),dateObj=null,tmpArr=[];if(dateType==="string"&&this.dateFormatReg.test(mixDate)){dateObj={};tmpArr=mixDate.split("-");dateObj.year=parseInt(tmpArr[0],10);dateObj.month=parseInt(tmpArr[1],10);dateObj.day=parseInt(tmpArr[2],10);}else{if(rawDateType==="[object Date]"){dateObj={year:mixDate.getFullYear(),month:mixDate.getMonth()+1,day:mixDate.getDate()};}else{if(dateType==="number"||rawDateType==="[object Number]"){mixDate=new Date(mixDate);dateObj={year:mixDate.getFullYear(),month:mixDate.getMonth()+1,day:mixDate.getDate()};}}}return dateObj;},getLimitDates:function(){return{minDate:this.getDateObj(this.opts.minDate),maxDate:this.getDateObj(this.opts.maxDate)};},processError:function(){var opts=this.opts,$elm=this.$elm,isValid=false,actDateStr=$elm.val(),actDateObj,minDate=this.getDateObj(opts.minDate),maxDate=this.getDateObj(opts.maxDate),returnVal=true;if($.trim(actDateStr)===""){isValid=true;}else{if(this.dateFormatReg.test(actDateStr)){actDateObj=this.getActiveDate();if((actDateObj.curYear>minDate.year||(actDateObj.curYear===minDate.year&&actDateObj.curMonth>minDate.month)||(actDateObj.curYear===minDate.year&&actDateObj.curMonth===minDate.month&&actDateObj.curDay>=minDate.day))&&(actDateObj.curYear<maxDate.year||(actDateObj.curYear===maxDate.year&&actDateObj.curMonth<maxDate.month)||(actDateObj.curYear===maxDate.year&&actDateObj.curMonth===maxDate.month&&actDateObj.curDay<=maxDate.day))){isValid=true;}}}if(isValid){this.hide();}else{switch(opts.errMode){case"alert":window.alert(opts.errMessage);$elm.focus();break;case"confirm":if(window.confirm(opts.errConfirmMsg)){$elm.val("").focus();}else{$elm.focus();}break;case"clear":$elm.val("").focus();returnVal=false;break;case"custom":if(typeof opts.errHandler==="function"){returnVal=opts.errHandler.call(this);returnVal=returnVal===undefined?true:returnVal;}break;default:this.hide();}}return returnVal;}};$.fn.datepicker=function(options){var opts=$.extend({},$.fn.datepicker.defaults,options);return this.each(function(){return new $.Datepicker(this,opts);});};$.fn.datepicker.defaults={dateFormat:"Y-m-d",minDate:"1900-01-01",maxDate:"2099-12-31",firstDay:0,onSelect:null,showOn:"focus",errMode:"confirm",errHandler:null,errMessage:"不合法的日期格式或者日期超出限定范围",errConfirmMsg:"不合法的日期格式或者日期超出限定范围,需要撤销吗?",weekNames:["日","一","二","三","四","五","六"],months:["一月","二月","三月","四月","五月","六月","七月","八月","九月","十月","十一","十二"]};}(jQuery));